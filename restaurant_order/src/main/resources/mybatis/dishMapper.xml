<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eve.dao.dishMapper">
	<resultMap id="BaseResultMap" type="com.eve.entity.Dish">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="ID" jdbcType="INTEGER" property="id" />
		<result column="NAME" jdbcType="VARCHAR" property="name" />
		<result column="DESCRIPTION" jdbcType="VARCHAR" property="description" />
		<result column="DISH_TYPE_ID" jdbcType="INTEGER" property="dishTypeId" />
		<result column="PRICE" jdbcType="DECIMAL" property="price" />

	</resultMap>



	<select id="selectByPrimaryKey" parameterType="long" resultMap="BaseResultMap">
		select ID, NAME, DESCRIPTION, DISH_TYPE_ID, PRICE
		from TM_DISH
		where ID
		= #{id}
	</select>

	<select id="searchTypeID" parameterType="String" resultType="long">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select ID
		from TM_DISH_TYPE
		where NAME
		= #{typeName}
	</select>



	<resultMap id="BaseDishMap" type="com.eve.dto.DishDto">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="ID" jdbcType="INTEGER" property="id" />
		<result column="NAME" jdbcType="VARCHAR" property="name" />
		<result column="DESCRIPTION" jdbcType="VARCHAR" property="description" />
		<result column="DISH_TYPE_ID" jdbcType="INTEGER" property="dishTypeId" />
		<result column="PRICE" jdbcType="DECIMAL" property="price" />
		<result column="T_NAME" jdbcType="VARCHAR" property="typeName" />
	</resultMap>


	<select id="selectAll" resultMap="BaseDishMap">
		select d.ID, d.NAME ,
		d.DESCRIPTION, d.DISH_TYPE_ID, d.PRICE, t.name as T_NAME
		from TM_DISH d
		LEFT JOIN
		TM_DISH_TYPE t
		on d.dish_type_id = t.id
		order by PRICE
	</select>

	<insert id="insert" parameterType="com.eve.entity.Dish">
		<selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
			SELECT SQ_DISH.NEXTVAL FROM DUAL
		</selectKey>
		insert into TM_DISH (ID, NAME, DESCRIPTION,
		DISH_TYPE_ID, PRICE)
		values
		(#{id,jdbcType=DECIMAL}, #{name,jdbcType=VARCHAR},
		#{description,jdbcType=VARCHAR},
		#{dishTypeId,jdbcType=DECIMAL},
		#{price,jdbcType=DECIMAL})
	</insert>

	<insert id="insertList" parameterType="java.util.List"
		useGeneratedKeys="false">
		insert into
		TM_DISH(ID, NAME, DESCRIPTION, DISH_TYPE_ID, PRICE)
		SELECT
		SQ_DISH.NEXTVAL,a.*
		FROM (
		<foreach collection="dishes" item="dish" separator="union all">
			SELECT
			#{dish.name},
			#{dish.description},
			#{dish.dishTypeId},
			#{dish.price}
			FROM dual
		</foreach>
		) a
	</insert>


	<update id="changePrice">
		update TM_DISH set PRICE = #{price} where ID = #{id}
	</update>



	<resultMap id="OrderResultMap" type="com.eve.entity.Order">
		<id column="ID" jdbcType="INTEGER" property="id" />
		<result column="ROOM_ID" jdbcType="INTEGER" property="roomId" />
		<result column="TOTAL_PRICE" jdbcType="DECIMAL" property="totalPrice" />
		<result column="STATE" jdbcType="INTEGER" property="state" />
		<result column="CREATED_ON" jdbcType="TIMESTAMP" property="createdOn" />
		<result column="CUSTOMER_NAME" jdbcType="VARCHAR" property="customerName" />
		<result column="PHONE" jdbcType="VARCHAR" property="phone" />
	</resultMap>

	<insert id="getRoom" parameterType="com.eve.entity.Order">
		<selectKey keyProperty="id" order="BEFORE" resultType="LONG">
			SELECT SQ_ORDER.NEXTVAL FROM DUAL
		</selectKey>
		insert into TT_ORDER (ID, ROOM_ID, TOTAL_PRICE,
		STATE, CREATED_ON,
		CUSTOMER_NAME, PHONE
		)
		values (#{id}, #{roomId},
		#{totalPrice},
		#{state},
		#{createdOn}, #{customerName},#{phone}
		)
	</insert>

	<select id="check" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM TT_ORDER
		where ROOM_ID = #{roomId} and STATE = 0
	</select>

	<select id="checkOrderId" resultType="long">
		SELECT ID
		FROM TT_ORDER
		where ROOM_ID = #{roomId}
	</select>


	<select id="selectUnpayedByRoomId" resultMap="OrderResultMap">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select ID, CREATED_ON, PAYED_ON, TOTAL_PRICE, ROOM_ID, STATE
		from
		TT_ORDER where ROOM_ID = #{roomId} and STATE = 0
	</select>


	<insert id="orderDishes" parameterType="java.util.List"
		useGeneratedKeys="false">
		insert into
		TR_ORDER_ITEM (ID, ORDER_ID,DISH_ID, STATE)
		SELECT
		SQ_ORDER_ITEM.NEXTVAL,a.*
		FROM (
		<foreach collection="orderItem" item="item" separator="union all">
			SELECT
			#{item.orderId},
			#{item.dishId},
			#{item.state}
			FROM dual
		</foreach>
		) a
	</insert>


	<select id="freshPrice" resultType="long">
		select sum(b.price) from
		TR_ORDER_ITEM a ,
		TM_DISH b
		where a.DISH_ID = b.ID and a.ORDER_ID =
		#{orderId}
	</select>

	<update id="freshPrice_table">
		update TT_ORDER set TOTAL_PRICE =
		#{totalPrice} where
		ID = #{orderId}
	</update>

	<select id="brief" resultMap="OrderResultMap">
		select * from
		TT_ORDER
		where ROOM_ID
		= #{roomId}
	</select>

	<select id="checkDishes" resultMap="BaseResultMap">
		select d.*
		from
		TT_ORDER O,
		TR_ORDER_ITEM i,
		TM_DISH d
		where o.room_id=#{roomId} and o.id=i.order_id
		and
		i.dish_id=d.id
	</select>


	<resultMap id="OrderDtoResultMap" type="com.eve.dto.OrderDto">
		<id column="ID" jdbcType="INTEGER" property="id" />
		<result column="ROOM_ID" jdbcType="INTEGER" property="roomId" />
		<result column="TOTAL_PRICE" jdbcType="DECIMAL" property="totalPrice" />
		<result column="STATE" jdbcType="INTEGER" property="state" />
		<result column="CREATED_ON" jdbcType="TIMESTAMP" property="createdOn" />
		<result column="CUSTOMER_NAME" jdbcType="VARCHAR" property="customerName" />
		<result column="PHONE" jdbcType="VARCHAR" property="phone" />
	</resultMap>


	<select id="detail" resultMap="OrderDtoResultMap">
		select * from
		TT_ORDER
		where ROOM_ID
		= #{roomId}
	</select>

	<resultMap id="testMap" type="com.eve.dto.OrderDto">

		<id column="ID" jdbcType="INTEGER" property="id" />
		<result column="ROOM_ID" jdbcType="INTEGER" property="roomId" />
		<result column="TOTAL_PRICE" jdbcType="DECIMAL" property="totalPrice" />
		<result column="STATE" jdbcType="INTEGER" property="state" />
		<result column="CREATED_ON" jdbcType="TIMESTAMP" property="createdOn" />
		<result column="CUSTOMER_NAME" jdbcType="VARCHAR" property="customerName" />
		<result column="PHONE" jdbcType="VARCHAR" property="phone" />
		<collection property="orderDishes" ofType="com.eve.entity.Dish"
			javaType="ArrayList" resultMap="BaseResultMap" />

	</resultMap>



	<select id="test" resultMap="testMap">
		select o.*,d.*
		from
		TT_ORDER o,
		TR_ORDER_ITEM i,
		TM_DISH d
		where o.room_id= #{roomId} and o.id=i.order_id and
		i.dish_id=d.id

	</select>


</mapper>